# Docker Compose for Legacy Adapter Local Development (Mac M2)
#
# This file is named docker-compose.dev.yml (not docker-compose.local.yml)
# to avoid conflicts with the main backend docker-compose.local.yml
#
# Use this to test the adapter service on your Mac before deploying to VPS
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d
#   docker compose -f docker-compose.dev.yml logs -f
#   docker compose -f docker-compose.dev.yml down

services:
  legacy-adapter:
    build:
      context: .
      dockerfile: Dockerfile
    platform: linux/amd64  # Required for pymssql (emulated on Mac M2)
    container_name: legacy_adapter_local
    restart: unless-stopped
    environment:
      # Legacy MSSQL connection
      - LEGACY_DB_HOST=${LEGACY_DB_HOST}
      - LEGACY_DB_PORT=${LEGACY_DB_PORT:-1433}
      - LEGACY_DB_USER=${LEGACY_DB_USER}
      - LEGACY_DB_PASSWORD=${LEGACY_DB_PASSWORD}
      - LEGACY_DB_NAME=${LEGACY_DB_NAME}

      # Security settings (relaxed for local dev)
      - API_KEY=${API_KEY:-dev-api-key-change-in-production}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8000,http://127.0.0.1:8000}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-120}

      # Application settings
      - DEBUG=${DEBUG:-true}  # Enable debug mode for local dev
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}

    ports:
      - "8001:8000"  # Expose on port 8001

    networks:
      - legacy-network

    # Hot reload for development
    volumes:
      - ./app:/app/app:ro  # Mount app code for development

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  legacy-network:
    driver: bridge
